AWSTemplateFormatVersion: "2010-09-09"
Description: "Cloudfront Resources Manager"
Parameters:
  EnvType:
    Description: Environment type.
    Type: String
    AllowedValues:
      - testing
      - preprod
      - sandbox
    Default: sandbox
  EnvSubType:
    Description: Environment Sub type.
    Type: String
    Default: main
Mappings:
  SSLCertificate:
    sandbox:
      #*.larciergroup-aws-testing.com (subdomain of *.larciergroup.com with subdomain) in us-east-1
      # certificate:  arn:aws:acm:us-east-1:266121229060:certificate/3c7c5e30-434c-441c-a8c9-ee1d51a3d7ba
      certificate: arn:aws:acm:us-east-1:645373646808:certificate/b3af9e93-2f80-45f5-87ec-2d64df3cb086
                    

                    
Resources:
  CloudFrontOriginaccessIdentity:
    Type: AWS::CloudFront::CloudFrontOriginAccessIdentity
    Properties:
      CloudFrontOriginAccessIdentityConfig:
        Comment: resources-manager
  CloudFrontDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Aliases:
          - Fn::Join:
              - ''
              - - resources-manager-
                - Ref: EnvSubType
                - .
                - sandbox.els-lab.eu
        Origins:
          - DomainName:
              Fn::ImportValue:
                Fn::Join:
                  - ':'
                  - - DashBoardBucket
                    - Ref: EnvType
                    - Ref: EnvSubType
                    - DomainName
            Id: myS3Origin
            S3OriginConfig:
              OriginAccessIdentity:
                Fn::Join:
                  - ''
                  - - origin-access-identity/cloudfront/
                    - Ref: CloudFrontOriginaccessIdentity
            OriginCustomHeaders:
              - HeaderName: Access-Control-Allow-Origin
                HeaderValue: '*'
        Enabled: 'true'
        DefaultRootObject: index.html
        DefaultCacheBehavior:
          AllowedMethods:
            - GET
            - HEAD
            - OPTIONS
          CachedMethods:
            - GET
            - HEAD
            - OPTIONS
          TargetOriginId: myS3Origin
          Compress: 'True'
          ForwardedValues:
            QueryString: 'false'
            Cookies:
              Forward: none
          MinTTL: '50'
          MaxTTL: '172800'
          ViewerProtocolPolicy: redirect-to-https          
        ViewerCertificate:
          AcmCertificateArn: 
            Fn::FindInMap:
              - SSLCertificate
              - Ref: EnvType
              - certificate
          SslSupportMethod: sni-only
        CustomErrorResponses:
          - ErrorCode: 403
            ResponseCode: 200
            ResponsePagePath: /index.html
            ErrorCachingMinTTL: 0
          - ErrorCode: 404
            ResponseCode: 200
            ResponsePagePath: /index.html
            ErrorCachingMinTTL: 0
#   DNSZone:
#     Type: AWS::Route53::RecordSetGroup
#     Properties:
#       HostedZoneName: sandbox.els-lab.eu.
#       Comment: Zone apex alias targeted to Distribution Cloudfront.
#       RecordSets:
#         - Name:
#             Fn::Join:
#               - ''
#               - - resources-manager-
#                 - Ref: EnvSubType
#                 - .
#                 - sandbox.els-lab.eu
#           Type: A
#           AliasTarget:
#             HostedZoneId: Z1FEI92LPKPRO4
#             DNSName:
#               Fn::GetAtt:
#                 - CloudFrontDistribution
#                 - DomainName
